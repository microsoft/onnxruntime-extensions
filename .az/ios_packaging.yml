# packaging pipeline for iOS CocoaPods package

parameters:
- name: IsReleaseBuild
  displayName: "Is this is a release build?"
  type: boolean
  default: false

name: "$(Date:yyyyMMdd)$(Rev:rrr)"  # build number format

jobs:
- job: IosPackaging
  displayName: "iOS Packaging"

  pool:
    vmImage: "macOS-12"

  timeoutInMinutes: 120

  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: "3.9"
      addToPath: true
      architecture: "x64"

  # iOS xcframework build doesn't work with CMake 3.25.1, pin to 3.25.0
  - script: |
      python -m pip install cmake==3.25.0
    displayName: "Install CMake 3.25.0"

  - script: |
      python ./tools/ios/build_xcframework.py \
        --output-dir $(Build.BinariesDirectory)/xcframework_out \
        --config Release
    displayName: "Build xcframework"

  # <repo root>/.version.txt is generated by a build, so we put the step that reads it after the build step
  - bash: |
      set -e -x
      BASE_VERSION="$(cat ./.version.txt)"

      if [[ "${{ parameters.IsReleaseBuild }}" == "true" ]]; then
        VERSION="${BASE_VERSION}"
      else
        SHORT_COMMIT_HASH="$(git rev-parse --short HEAD)"
        VERSION="${BASE_VERSION}-dev+$(Build.BuildNumber).${SHORT_COMMIT_HASH}"
      fi

      set_var() {
        local VAR_NAME=${1:?}
        local VAR_VALUE=${2:?}
        echo "##vso[task.setvariable variable=${VAR_NAME}]${VAR_VALUE}"
        echo "${VAR_NAME}: ${VAR_VALUE}"
      }

      set_var "ORT_EXTENSIONS_POD_VERSION" "${VERSION}"
    displayName: "Set ORT_EXTENSIONS_POD_VERSION variable"

  - script: |
      python ./tools/ios/assemble_pod_package.py \
        --staging-dir $(Build.BinariesDirectory)/pod_staging \
        --xcframework-dir $(Build.BinariesDirectory)/xcframework_out/onnxruntime_extensions.xcframework \
        --public-headers-dir $(Build.BinariesDirectory)/xcframework_out/Headers \
        --framework-info-file $(Build.BinariesDirectory)/xcframework_out/framework_info.json \
        --pod-version ${ORT_EXTENSIONS_POD_VERSION}
    displayName: "Assemble pod"

  - script: |
      pod lib lint
    displayName: "Lint pod"
    workingDirectory: $(Build.BinariesDirectory)/pod_staging

  - script: |
      ORT_EXTENSIONS_LOCAL_POD_PATH=$(Build.BinariesDirectory)/pod_staging \
        pod install
    displayName: "Install pods for OrtExtensionsUsage"
    workingDirectory: $(Build.SourcesDirectory)/test/ios/OrtExtensionsUsage

  - template: templates/xcode-build-and-test-step.yml
    parameters:
      xcWorkspacePath: '$(Build.SourcesDirectory)/test/ios/OrtExtensionsUsage/OrtExtensionsUsage.xcworkspace'
      scheme: 'OrtExtensionsUsage'

  # TODO run test on app center

  - script: |
      set -e -x

      POD_STAGING_DIR="$(Build.BinariesDirectory)/pod_staging"
      ARTIFACTS_STAGING_DIR="$(Build.ArtifactStagingDirectory)"
      POD_NAME="onnxruntime-extensions-c"
      POD_ARCHIVE_BASENAME="pod-archive-${POD_NAME}-${ORT_EXTENSIONS_POD_VERSION}.zip"
      PODSPEC_BASENAME="${POD_NAME}.podspec"

      pushd ${POD_STAGING_DIR}

      # assemble the files in the artifacts staging directory
      zip -r ${ARTIFACTS_STAGING_DIR}/${POD_ARCHIVE_BASENAME} * --exclude ${PODSPEC_BASENAME}
      cp ${PODSPEC_BASENAME} ${ARTIFACTS_STAGING_DIR}/${PODSPEC_BASENAME}

      popd
    displayName: "Assemble artifacts"

  - publish: "$(Build.ArtifactStagingDirectory)"
    artifact: ios_packaging_artifacts
    displayName: "Publish artifacts"
